# 10.01. Зачем и что нужно мониторить

## Обязательные задания

1. Вас пригласили настроить мониторинг на проект. На онбординге вам рассказали, что проект представляет из себя 
платформу для вычислений с выдачей текстовых отчетов, которые сохраняются на диск. Взаимодействие с платформой 
осуществляется по протоколу http. Также вам отметили, что вычисления загружают ЦПУ. Какой минимальный набор метрик вы
выведите в мониторинг и почему?

2. Менеджер продукта посмотрев на ваши метрики сказал, что ему непонятно что такое RAM/inodes/CPUla. Также он сказал, 
что хочет понимать, насколько мы выполняем свои обязанности перед клиентами и какое качество обслуживания. Что вы 
можете ему предложить?

3. Вашей DevOps команде в этом году не выделили финансирование на построение системы сбора логов. Разработчики в свою 
очередь хотят видеть все ошибки, которые выдают их приложения. Какое решение вы можете предпринять в этой ситуации, 
чтобы разработчики получали ошибки приложения?

3. Вы, как опытный SRE, сделали мониторинг, куда вывели отображения выполнения SLA=99% по http-кодам ответов. 
Вычисляете этот параметр по следующей формуле: summ_2xx_requests/summ_all_requests. Данный параметр не поднимается выше 
70%, но при этом в вашей системе нет кодов ответа 5xx и 4xx. Где у вас ошибка?

---
### 1. Минимальный набор метрик

Я бы вывел в систему логирования:

1. CPU
2. RAM
3. IOPS
4. Количество HTTP-запросов
5. Время выполнения HTTP-запроса
6. Время генерации отчета
7. Процент успешных генераций отчетов, относительно всех генераций.

Проверил бы что эта за нагрузка на CPU(если это будет проверять Сергей, то вопрос точно должен быть об этом)
Метрика CPU-load может быть высокой, при этом процессор будет находиться в состоянии stalled, а не busy.
Т.е. он будет ожидать ответа от памяти. Если это так, то дальше уже копать в сторону оптимизации 
взаимодействия приложения с памятью.

### 2. Что за метрики RAM/inodes/CPU и ответ на вопрос какое у продукта качество обслуживания.

1. RAM - процент потребляемой памяти серверами, т.е. нагрузка по памяти.
2. CPU - процент нагруженности CPU.
3. inodes - количество использованных inodes по файловым системам серверов, которые использует продукт. 
Если он превысит 100% операционная система не сможет создавать новые файлы, любые операции записи будут завершаться 
ошибкой. Система не будет работать, несмотря на то что в ней еще есть свободная память на дисках и RAM/CPU.

Упускаем ответы на вопросы о том что такое SLA/SLO, про это подробно можно почитать в статье ниже от Atlassian.
Сделаем акцент на индикаторах уровня обслуживания SLI. SLI - это измеримые индикаторы, которые помогают понять насколько
сервис выполняет SLO(более точные цели уровня обслуживания) и соответственно удовлетворяет требованиям SLA
(формальным соглашениям об обязательствах перед клиентами).

Индикаторы SLI должны быть только для критически важных показателей, простыми и легко измеримыми.

Поэтому я бы показал менеджеру следующие SLI:

1. Среднее число времени доступности продукта(т.е. uptime систем из которых состоит продукт) за последний месяц, квартал, полугодие, год.
А также график за эти периоды, если менеджеру это было бы интересно.
При этом в этот критерий попадают только критически важные системы, которые были формально внесены в SLA. 
Я имею в виду, что сюда не входят абсолютно все системы.

2. Показатель корректных ответов относительно всех запросов.
А также, в случае необходимости, отдельно детально соотношение http-ответов(2xx, 3xx, 4xx, 5xx).
Также разбив по периодам и отдельно графиками, если это необходимо.
Например, если явно был какой-то сбой и система была недоступна, чтобы понять насколько это было критичным.

3. Бизнес SLI - например, если это банковская система, система оформления заказов или еще что-то(где важно чтобы какой-то
результат от использования продукта был получен клиентом) имеет очень большое значение вынести эти показатели в мониторинг.

P.S.: выносить в SLI показатели RAM/CPU/inodes, по-моему, нет никакого смысла. Это больше метрики, которые помогают
инженерам понять что что-то может идти не так, а также предвидеть ситуации нехватки ресурсов и заранее их увеличить. 

### 3. Подключение инструмента мониторинга ошибок.

1. Установить Sentry с аккаунтом в самом сервисе. Перехваченные ошибки будут храниться в облаке самого sentry,
он позволяет хранить бесплатно до 10 тысяч перехваченных ошибок в месяц. Для проекта в котором не выделили финансирование
на мониторинг это более чем достаточно.

2. Если этого недостаточно можно установить Sentry в локально, это понесет некоторые накладные расходы, но все равно
гораздо меньшие чем развертывание собственной системы мониторинга. А также данные об ошибках не будут передаваться
третьим лицам, что может быть критически важным по политике безопасности компании.

### 4. Ошибка в формуле расчета SLI

Формула не учитывает **3xx-ответы**. Правильная будет:

`SLI = (summ_2xx_requests + summ_3xx_requests) / summ_all_requests`

### Материалы которые мне помогли

1. CPU utilization is wrong -  https://www.brendangregg.com/blog/2017-05-09/cpu-utilization-is-wrong.html
2. SLA, SLO, SLI в чем разница? - https://www.atlassian.com/ru/incident-management/kpis/sla-vs-slo-vs-sli

## Дополнительное задание (со звездочкой*) - необязательно к выполнению

Вы устроились на работу в стартап. На данный момент у вас нет возможности развернуть полноценную систему 
мониторинга, и вы решили самостоятельно написать простой python3-скрипт для сбора основных метрик сервера. Вы, как 
опытный системный-администратор, знаете, что системная информация сервера лежит в директории `/proc`. 
Также, вы знаете, что в системе Linux есть  планировщик задач cron, который может запускать задачи по расписанию.

Суммировав все, вы спроектировали приложение, которое:
- является python3 скриптом
- собирает метрики из папки `/proc`
- складывает метрики в файл 'YY-MM-DD-awesome-monitoring.log' в директорию /var/log 
(YY - год, MM - месяц, DD - день)
- каждый сбор метрик складывается в виде json-строки, в виде:
  + timestamp (временная метка, int, unixtimestamp)
  + metric_1 (метрика 1)
  + metric_2 (метрика 2)
  
     ...
     
  + metric_N (метрика N)
  
- сбор метрик происходит каждую 1 минуту по cron-расписанию

Для успешного выполнения задания нужно привести:

а) работающий код python3-скрипта,

б) конфигурацию cron-расписания,

в) пример верно сформированного 'YY-MM-DD-awesome-monitoring.log', имеющий не менее 5 записей,

P.S.: количество собираемых метрик должно быть не менее 4-х.
P.P.S.: по желанию можно себя не ограничивать только сбором метрик из `/proc`.

---